#!/bin/bash
#-------------------------------------------------------------------------------
# Script that builds OpenXAL distribution RPMs
#
#
#
# Author: miroslav.pavleski@cosylab.com
#-------------------------------------------------------------------------------

GREEN='\e[0;32m'
YELLOW='\e[1;33m'
RED='\e[0;31m'
NC='\e[0m'

if [ -z "$1" ]; then
    echo "Usage: package-openxal DESTINATION_PATH_FOR_RPMs"
    echo ""
    echo " Command assumes following projects are side-by-side in the directory structure: "
    echo ""
    echo "  openxal"
    echo "  openxal-score"
    
    exit 1
fi

DESTINATION_DIR="$1"
if [ -z "$PROJECTDIR" ]; then
    # Assuming we are in openxal/packaging 
    PROJECTDIR=`readlink -f  $(pwd)/../..`
    echo PROJECTDIR not defined. Defaulting to $PROJECTDIR
fi

#-------------------------------------------------------------------------------
# List all directories containing RPM building pom.xml-s
#
# Here we list RPM pom.xml directories
# !! Note: Order importand, the packages bellow might depend on the packages at the top.
#
#-------------------------------------------------------------------------------
declare -a RPM_DIRS=(
    # ESS configuration specific data
    "$PROJECTDIR/openxal/packaging/ess-data"
    
    # Core libraries
    "$PROJECTDIR/openxal/core/packaging"

    # OpenXAL applications
    "$PROJECTDIR/openxal/apps/packaging/bricks"
    "$PROJECTDIR/openxal/apps/packaging/dbbrowser"
    "$PROJECTDIR/openxal/apps/packaging/extlatgenerator"
    "$PROJECTDIR/openxal/apps/packaging/knobs"
    "$PROJECTDIR/openxal/apps/packaging/launcher"
    "$PROJECTDIR/openxal/apps/packaging/machinesimulator"
    "$PROJECTDIR/openxal/apps/packaging/mtv"
    "$PROJECTDIR/openxal/apps/packaging/opticseditor"
    "$PROJECTDIR/openxal/apps/packaging/opticsswitcher"
    "$PROJECTDIR/openxal/apps/packaging/orbitcorrect"
    "$PROJECTDIR/openxal/apps/packaging/pvhistogram"
    "$PROJECTDIR/openxal/apps/packaging/pvlogger"
    "$PROJECTDIR/openxal/apps/packaging/scan1d"
    "$PROJECTDIR/openxal/apps/packaging/scan2d"
    "$PROJECTDIR/openxal/apps/packaging/scope"
    "$PROJECTDIR/openxal/apps/packaging/virtualaccelerator"
    "$PROJECTDIR/openxal/apps/packaging/xyzcorrelator"
    
    # PV Logger Service
    "$PROJECTDIR/openxal/services/pvlogger/packaging"
    
    # Score Application
    "$PROJECTDIR/openxal-score/packaging"
    
    # The OpenXAL meta-package
    "$PROJECTDIR/openxal/packaging/openxal-meta"
)

#-------------------------------------------------------------------------------
# Clean, build and RPM Upgrade all RPMs in order
#-------------------------------------------------------------------------------
for i in "${RPM_DIRS[@]}"
do
    printf "\n\n${YELLOW}Building RPM in $i directory.${NC}\n\n"
    
    cd "$i"
    if [ $? -ne 0 ]; then
        echo ${RED}Invalid RPM project directory detected: $i ${NC}
        exit 2
    fi
    
    mvn clean && mvn package
    if [ $? -ne 0 ]; then
        echo ${RED}Failed to package project in $i ${NC}
        exit 3
    fi

    sudo rpm -U --replacepkgs --replacefiles target/*.rpm
    if [ $? -ne 0 ]; then
        echo ${RED}RPM Install failed for $i ${NC}
        exit 4
    fi
done
cd "$PROJECTDIR"


#-------------------------------------------------------------------------------
# Copy RPMs to destination directory
#-------------------------------------------------------------------------------
printf "\n\n${GREEN}RPM Packages built successfully.\nCopying to $DESTINATION_DIR  ..."
for i in "${RPM_DIRS[@]}"
do
    cp -f "$i"/target/*.rpm "$DESTINATION_DIR"
done
printf "DONE.${NC}\n\n"
